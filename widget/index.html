<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- build:bundleCSSFiles  -->
	<link rel="stylesheet" href="css/widget.css">
	<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
    <!-- endbuild -->

    <!-- build:bundleWidgetBFMinJS  -->
	<script src="../../../scripts/buildfire.js"></script>
    <!-- endbuild -->
	
	<!-- build:bundleJSFiles  -->
	<script src="../data/setting.js"></script>
    <script src="../data/weatherInfo.js"></script>
    <script src="../dataAccess/settings.js"></script>
    <script src="../dataAccess/weatherData.js"></script>
	<!-- endbuild -->

	<!-- build:bundleSharedJSFiles  -->
	<script src="js/shared/infoCard.class.js"></script>
    <script src="js/shared/strings.js"></script>
	<script src="js/shared/stringsConfig.js"></script>
	<script src="../widget/js/shared/authManager.js"></script>
	<!-- endbuild -->


</head>
<body>
	<div class="main__container">
		<div class="location--title">
			<p id="location--title"></p>
		</div>
		<div class="temperature__container" id="temperature__container">
			<span id="weather--information"></span>
			<img id="image--information">
		</div>
		<div class="bottom-container mdc-layout-grid__inner">
			<div class="mdc-layout-grid__cell">
				<label for="wind--information">Wind</label>
				<span class="mdc-layout-grid--align-right" id="wind--information"></span>
			</div>
			<hr role="separator" class="mdc-list-divider">
			<div class="mdc-layout-grid__cell">
				<label for="humidity--information">Humidity</label>
				<span class="mdc-layout-grid--align-right" id="humidity--information"></span>
			</div>
			<hr role="separator" class="mdc-list-divider">
			<div class="mdc-layout-grid__cell">
				<label for="min-temp--information">Min temperature</label>
				<span class="mdc-layout-grid--align-right" id="min-temp--information"></span>
			</div>
			<hr role="separator" class="mdc-list-divider">
			<div class="mdc-layout-grid__cell">
				<label for="max-temp--information">Max temperature</label>
				<span class="mdc-layout-grid--align-right" id="max-temp--information"></span>
			</div>
		</div>
	</div>
<script>
	window.onload = (event) => {
		Settings.get((err, data) => {
			if (err) return console.log(err);
			this.initView(data);
		});

		Settings.update((event) => {
			this.initView(event.data);
		});
	}
	fetchWeatherData = (latitude, longitude, tempUnit, apiKey, callback) => {
    /// Call open weather API to pull data
    fetch("https://api.openweathermap.org/data/2.5/find?appid=" + apiKey + "&lat=" + latitude + "&lon=" + longitude + tempUnit
    ).then(function (response) {
        response.json().then(function (results) {
            if (results && results.list && results.list.length)
                callback(null, results);
            else
                callback("failed to load weather data ");
        });
    }).catch(function () {
        callback("failed to fetch weather data");
    });
};

initView = (data) => {

    let tempUnit;
    if (data.tempUnit === 'metric')
        tempUnit = '&units=metric';
    else if (data.tempUnit === 'imperial')
        tempUnit = '&units=imperial';
    else
        tempUnit = '';

    fetchWeatherData(data.place.address.lat, data.place.address.lng, tempUnit, data.apiKey, (err, response) => {
        if (err) return console.log(err);
        let weatherStatus = response.list[0];
        console.log(weatherStatus);
        let temperature = parseInt(weatherStatus.main.temp);
        let formatedTemperature = temperature.toString();

        let minTemperature = parseInt(weatherStatus.main.temp_min);
        let formatedMinTemperature = minTemperature.toString();

        let maxTemperature = parseInt(weatherStatus.main.temp_max);
        let formatedMaxTemperature = maxTemperature.toString();

        let wind = weatherStatus.wind.speed.toString() + 'mph';
        let humidity = weatherStatus.main.humidity.toString() + "%";
        
        let rain;
        if (weatherStatus.rain !== null)
            rain = Object.values(weatherStatus.rain)[0].toString() + 'mm';
        else
            rain = '0mm';
        
        let snow;
        if (weatherStatus.snow !== null)
            snow = Object.values(weatherStatus.snow).toString() + 'mm';
        else
            snow = '0mm';
        
        if (data.tempUnit === 'metric') {
            formatedTemperature += ' °C';
            formatedMinTemperature += ' °C';
            formatedMaxTemperature += ' °C';
        }
            
        else if (data.tempUnit === 'imperial') {
            formatedTemperature += 'F';
            formatedMinTemperature += 'F';
            formatedMaxTemperature += 'F';
        }
        else {
            formatedTemperature += 'K';
            formatedMinTemperature += 'K';
            formatedMaxTemperature += 'K';
        }

        if (weatherStatus.clouds.all > 50 && !weatherStatus.rain && !weatherStatus.snow) {
            this.createWeatherElement('.images/iconfinder_Overcast.ico');
        }
        else if (weatherStatus.rain && !weatherStatus.snow) {
            this.createWeatherElement('.images/iconfinder_Hail_Heavy.ico');
        }
        else if (weatherStatus.snow && !weatherStatus.rain) {
            this.createWeatherElement('.images/iconfinder_Snow_Occasional.ico');
        }
        else {
            this.createWeatherElement('.images/iconfinder_Sunny.ico');
        }
            
        document.getElementById('location--title').innerHTML = data.place.title;
        document.getElementById('weather--information').innerHTML = formatedTemperature;
        document.getElementById('wind--information').innerHTML = wind;
        document.getElementById('humidity--information').innerHTML = humidity;
        document.getElementById('min-temp--information').innerHTML = formatedMinTemperature;
        document.getElementById('max-temp--information').innerHTML = formatedMaxTemperature;
    });
};

createWeatherElement = (attr) => {
    document.getElementById('image--information').setAttribute('src', attr);
};
    
</script>
</body>
</html>